<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üåç Global Aide Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:#0b1220;
  color:#e5e7eb;
  font-family:system-ui;
}
.container{
  max-width:720px;
  margin:auto;
  height:100vh;
  display:flex;
  flex-direction:column;
}
.header{
  padding:12px;
  background:#020617;
  display:flex;
  justify-content:space-between;
}
.chat{
  height:50vh;
  overflow:auto;
  padding:12px;
}
.msg{
  background:#020617;
  border-radius:12px;
  padding:10px;
  margin-bottom:10px;
}
.user{color:#38bdf8;font-size:13px}
img{width:100%;border-radius:10px;margin-top:6px}
audio{width:100%;margin-top:6px}
.inputBox{
  padding:10px;
  background:#020617;
}
.controls{display:flex;gap:6px;margin-bottom:6px}
input,button{
  padding:10px;border-radius:10px;border:none;
}
input[type=text]{flex:1;background:#020617;color:#fff}
button{background:#38bdf8;font-weight:600}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <div>üåç Global Chat</div>
    <div id="online">üü¢ 0 online</div>
  </div>

  <div id="chat" class="chat"></div>

  <div class="inputBox">
    <div class="controls">
      <input type="file" id="images" accept="image/*" multiple>
      <input type="file" id="audio" accept="audio/mpeg">
    </div>
    <div class="controls">
      <input id="message" type="text" placeholder="Type message‚Ä¶">
      <button id="send">Send</button>
    </div>
  </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc,
  query, orderBy, limit, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import {
  getDatabase, ref, push, onDisconnect, onValue
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* üîπ Firebase */
const firebaseConfig={
  apiKey:"AIzaSyDMGU5X7BBp-C6tIl34Uuu5N9MXAVFTn7c",
  authDomain:"paper-house-inc.firebaseapp.com",
  projectId:"paper-house-inc",
  messagingSenderId:"658389836376",
  appId:"1:658389836376:web:2ab1e2743c593f4ca8e02d"
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

/* üë§ Username */
let username=Telegram?.WebApp?.initDataUnsafe?.user?.username
 ? "@"+Telegram.WebApp.initDataUnsafe.user.username
 : "Guest-"+Math.floor(Math.random()*9000+1000);

/* üü¢ Presence */
const rdb=getDatabase(app);
const me=push(ref(rdb,"presence"));
me.set(username);
onDisconnect(me).remove();
onValue(ref(rdb,"presence"),s=>{
  online.innerText=`üü¢ ${s.size||0} online`;
});

/* üß† Helpers */
const toBase64=f=>new Promise(res=>{
  const r=new FileReader();
  r.onload=()=>res(r.result);
  r.readAsDataURL(f);
});

/* üî• Rate limit */
let times=[];

/* üì§ SEND */
send.onclick=async()=>{
  const text=message.value.trim();
  const imgs=[...images.files].slice(0,5);
  const aud=audio.files[0];

  const now=Date.now();
  times=times.filter(t=>now-t<60000);
  if(times.length>=5){alert("Max 5 msgs/min");return;}
  times.push(now);

  let img64=[], aud64=null;

  for(const f of imgs){
    if(f.size>150000){alert("Image too big");return;}
    img64.push(await toBase64(f));
  }

  if(aud){
    if(aud.size>300000){alert("Audio too big");return;}
    aud64=await toBase64(aud);
  }

  await addDoc(collection(db,"globalChat"),{
    user:username,
    text,
    images:img64,
    audio:aud64,
    time:serverTimestamp()
  });

  message.value="";
  images.value="";
  audio.value="";
};

/* üí¨ CHAT */
onSnapshot(
  query(collection(db,"globalChat"),orderBy("time"),limit(5000)),
  snap=>{
    chat.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg";
      div.innerHTML=`
        <div class="user">üë§ ${m.user}</div>
        ${m.text?`<div>${m.text}</div>`:""}
        ${(m.images||[]).map(i=>`<img src="${i}">`).join("")}
        ${m.audio?`<audio controls src="${m.audio}"></audio>
        <a href="${m.audio}" download>‚¨á Download MP3</a>`:""}
      `;
      chat.appendChild(div);
    });
    chat.scrollTop=chat.scrollHeight;
});
</script>
</body>
</html>
