<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ğŸŒ Global Aide Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#0b1220;
  --card:#020617;
  --accent:#38bdf8;
  --text:#e5e7eb;
  --muted:#94a3b8;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui;
}

.container{
  max-width:720px;
  margin:auto;
  height:100vh;
  display:flex;
  flex-direction:column;
}

.header{
  padding:12px;
  background:#020617;
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid #1e293b;
}

.chat{
  height:50vh; /* ğŸ”¥ half screen */
  overflow-y:auto;
  padding:12px;
}

.msg{
  background:var(--card);
  border-radius:12px;
  padding:10px;
  margin-bottom:10px;
}

.user{
  font-size:13px;
  color:var(--accent);
}

.text{
  margin-top:4px;
  font-size:15px;
}

.time{
  font-size:11px;
  color:var(--muted);
  margin-top:4px;
}

.inputBox{
  display:flex;
  gap:6px;
  padding:10px;
  background:#020617;
  border-top:1px solid #1e293b;
}

input{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:none;
  outline:none;
  background:#020617;
  color:#fff;
}

button{
  padding:10px 14px;
  border-radius:10px;
  border:none;
  background:var(--accent);
  font-weight:600;
}
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <div>ğŸŒ Global Live Chat</div>
    <div id="online">ğŸŸ¢ 0 online</div>
  </div>

  <div id="chat" class="chat"></div>

  <div class="inputBox">
    <input id="message" placeholder="Type messageâ€¦" maxlength="200">
    <button id="sendBtn">Send</button>
  </div>

</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, query,
  orderBy, limit, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import {
  getDatabase, ref, onValue, push, onDisconnect
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* ğŸ”¹ Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyDMGU5X7BBp-C6tIl34Uuu5N9MXAVFTn7c",
  authDomain: "paper-house-inc.firebaseapp.com",
  projectId: "paper-house-inc",
  storageBucket: "paper-house-inc.firebasestorage.app",
  messagingSenderId: "658389836376",
  appId: "1:658389836376:web:2ab1e2743c593f4ca8e02d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ğŸ‘¤ LIVE USERNAME DETECTION */
let username;
if (window.Telegram?.WebApp?.initDataUnsafe?.user?.username) {
  username = "@" + Telegram.WebApp.initDataUnsafe.user.username;
} else {
  username = "Guest-" + Math.floor(1000 + Math.random() * 9000);
}

/* ğŸ”¥ MESSAGE LIMIT SETTINGS */
const MESSAGE_LIMIT = 5;
const WINDOW_MS = 60 * 1000;
let sentTimes = [];

/* ğŸ”¹ Firestore Chat */
const chatCol = collection(db, "globalChat");

/* ğŸ”¹ SEND MESSAGE (ANTI-SPAM) */
document.getElementById("sendBtn").onclick = async () => {
  const input = document.getElementById("message");
  const text = input.value.trim();
  if (!text) return;

  const now = Date.now();
  sentTimes = sentTimes.filter(t => now - t < WINDOW_MS);

  if (sentTimes.length >= MESSAGE_LIMIT) {
    alert("â³ Slow down â€” max 5 messages per minute.");
    return;
  }

  sentTimes.push(now);

  await addDoc(chatCol,{
    user: username,
    text,
    time: serverTimestamp()
  });

  input.value = "";
};

/* ğŸ”¹ LIVE CHAT (LAST 5K) */
const chatBox = document.getElementById("chat");
const q = query(chatCol, orderBy("time","asc"), limit(5000));

onSnapshot(q, snap => {
  chatBox.innerHTML = "";
  snap.forEach(docu => {
    const d = docu.data();
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = `
      <div class="user">ğŸ‘¤ ${escape(d.user)}</div>
      <div class="text">${escape(d.text)}</div>
      <div class="time">${new Date().toLocaleTimeString()}</div>
    `;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
});

/* ğŸŸ¢ ONLINE COUNT (Realtime DB Presence) */
const rdb = getDatabase(app);
const presenceRef = ref(rdb,"presence");
const me = push(presenceRef);
me.set(username);
onDisconnect(me).remove();

onValue(presenceRef, snap=>{
  document.getElementById("online").innerText =
    `ğŸŸ¢ ${snap.size || 0} online`;
});

/* ğŸ” Escape */
function escape(t){
  return t.replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",
    '"':"&quot;","'":"&#039;"
  }[m]));
}
</script>
</body>
</html>
